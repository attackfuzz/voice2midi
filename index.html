<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>クオンタイズ音階をMIDI保存（修正版）</title>
  <script src="https://cdn.jsdelivr.net/npm/jsmidgen@1.1.1/build/midgen.min.js"></script>
</head>
<body>
  <h2>クオンタイズ音階 → MIDIファイル保存（ログ付き）</h2>
  <label>BPM: <input id="bpmInput" type="number" value="120"></label>
  <button id="startBtn">録音開始</button>
  <button id="stopBtn">録音停止</button>
  <button id="downloadBtn">MIDI保存</button>
  <pre id="log"></pre>

  <script>
    let audioCtx, analyser, source, mediaStream;
    let recording = false;
    let notes = [];
    let rafId, startTime;

    const logArea = document.getElementById("log");
    function log(msg) {
      const t = new Date().toLocaleTimeString();
      logArea.textContent += `[${t}] ${msg}\n`;
      logArea.scrollTop = logArea.scrollHeight;
    }

    function freqToMidi(freq) {
      return Math.round(69 + 12 * Math.log2(freq / 440));
    }
    function midiToNoteName(midi) {
      const names = ["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];
      return names[midi % 12] + Math.floor(midi/12 - 1);
    }

    function autoCorrelate(buf, sampleRate) {
      let SIZE = buf.length;
      let rms = 0;
      for (let i=0;i<SIZE;i++) rms += buf[i]*buf[i];
      rms = Math.sqrt(rms/SIZE);
      if (rms<0.01) return null;

      let bestOffset=-1, bestCorrelation=0;
      for (let offset=80; offset<1000; offset++) {
        let correlation=0;
        for (let i=0;i<SIZE-offset;i++) correlation += buf[i]*buf[i+offset];
        correlation /= SIZE-offset;
        if (correlation>bestCorrelation) {
          bestCorrelation = correlation;
          bestOffset = offset;
        }
      }
      if (bestOffset===-1) return null;
      return sampleRate/bestOffset;
    }

    async function startRecording() {
      if (recording) return;
      try {
        const bpm = parseInt(document.getElementById("bpmInput").value, 10);
        const beatLength = 60 / bpm;
        const eighthLength = beatLength / 2;

        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        mediaStream = await navigator.mediaDevices.getUserMedia({ audio:true });
        source = audioCtx.createMediaStreamSource(mediaStream);
        analyser = audioCtx.createAnalyser();
        analyser.fftSize = 2048;
        source.connect(analyser);

        const buffer = new Float32Array(analyser.fftSize);
        startTime = audioCtx.currentTime;
        notes = [];

        function update() {
          if (!recording) return;
          analyser.getFloatTimeDomainData(buffer);
          let pitch = autoCorrelate(buffer, audioCtx.sampleRate);
          if (pitch) {
            let midi = freqToMidi(pitch);
            let name = midiToNoteName(midi);
            let elapsed = audioCtx.currentTime - startTime;
            let step = Math.round(elapsed / eighthLength);
            notes[step] = {midi, name};
            log(`音検出: ${name} (step=${step})`);
          }
          rafId = requestAnimationFrame(update);
        }
        recording = true;
        update();
        log(`?? 録音開始 (BPM=${bpm})`);
      } catch (err) {
        log("?? 録音開始失敗: " + err);
      }
    }

    function stopRecording() {
      if (!recording) {
        log("?? 録音は実行中ではありません");
        return;
      }
      recording = false;
      mediaStream.getTracks().forEach(t=>t.stop());
      cancelAnimationFrame(rafId);
      log("? 録音停止");
      log("保存されたノート数: " + notes.filter(Boolean).length);
    }

    function downloadMIDI() {
      log("?? MIDI保存処理開始");
      if (!notes.length) {
        log("?? 保存できるノートがありません");
        return;
      }
      try {
        const file = new MIDI.File();   // ← 修正ポイント
        const track = new MIDI.Track();
        file.addTrack(track);

        const bpm = parseInt(document.getElementById("bpmInput").value, 10);
        const eighthTicks = 128;
        track.setTempo(bpm);

        notes.forEach((n, i) => {
          if (!n) return;
          track.addNoteOn(0, n.midi, i * eighthTicks);
          track.addNoteOff(0, n.midi, i * eighthTicks + eighthTicks);
        });

        const midiBlob = new Blob([file.toBytes()], { type: "audio/midi" });
        const url = URL.createObjectURL(midiBlob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "quantized.mid";
        a.click();
        URL.revokeObjectURL(url);

        log("? MIDIファイル保存成功 → quantized.mid");
      } catch (err) {
        log("? MIDI保存失敗: " + err);
      }
    }

    document.getElementById("startBtn").onclick = startRecording;
    document.getElementById("stopBtn").onclick = stopRecording;
    document.getElementById("downloadBtn").onclick = downloadMIDI;
  </script>
</body>
</html>
