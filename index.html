<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Voice to MIDI Demo</title>
</head>
<body>
  <h2>Voice → MIDI 変換テスト</h2>
  <button id="startBtn">録音開始</button>
  <button id="stopBtn">録音停止</button>
  <button id="downloadBtn">MIDIダウンロード</button>
  <p id="status">待機中</p>
  <pre id="notes"></pre>

  <script src="https://cdn.jsdelivr.net/npm/jsmidgen@1.1.1/build/midgen.min.js"></script>
  <script>
    let audioContext, processor, micStream;
    let isRecording = false;
    let noteEvents = []; // {note, time}

    // 簡易YINによるピッチ推定
    function detectPitch(buffer, sampleRate) {
      let bestOffset = -1;
      let bestCorrelation = 0;
      let rms = 0;
      for (let i = 0; i < buffer.length; i++) {
        let val = buffer[i];
        rms += val * val;
      }
      rms = Math.sqrt(rms / buffer.length);
      if (rms < 0.01) return null;

      let size = buffer.length;
      for (let offset = 80; offset < 1000; offset++) {
        let correlation = 0;
        for (let i = 0; i < size - offset; i++) {
          correlation += buffer[i] * buffer[i + offset];
        }
        correlation = correlation / (size - offset);
        if (correlation > bestCorrelation) {
          bestCorrelation = correlation;
          bestOffset = offset;
        }
      }
      if (bestOffset === -1) return null;
      return sampleRate / bestOffset;
    }

    function freqToMidi(freq) {
      return Math.round(69 + 12 * Math.log2(freq / 440));
    }

    document.getElementById("startBtn").onclick = async () => {
      audioContext = new (window.AudioContext || window.webkitAudioContext)();
      micStream = await navigator.mediaDevices.getUserMedia({ audio: true });
      const source = audioContext.createMediaStreamSource(micStream);
      processor = audioContext.createScriptProcessor(2048, 1, 1);

      let startTime = audioContext.currentTime;
      processor.onaudioprocess = (e) => {
        let input = e.inputBuffer.getChannelData(0);
        let pitch = detectPitch(input, audioContext.sampleRate);
        if (pitch) {
          let midiNote = freqToMidi(pitch);
          noteEvents.push({ note: midiNote, time: audioContext.currentTime - startTime });
          document.getElementById("notes").textContent += midiNote + " ";
        }
      };
      source.connect(processor);
      processor.connect(audioContext.destination);
      isRecording = true;
      document.getElementById("status").textContent = "録音中...";
    };

    document.getElementById("stopBtn").onclick = () => {
      if (!isRecording) return;
      processor.disconnect();
      micStream.getTracks().forEach(track => track.stop());
      isRecording = false;
      document.getElementById("status").textContent = "録音停止";
    };

    document.getElementById("downloadBtn").onclick = () => {
      if (noteEvents.length === 0) {
        alert("録音データがありません");
        return;
      }

      let file = new Midi.File();
      let track = new Midi.Track();
      file.addTrack(track);

      let lastTime = 0;
      noteEvents.forEach(ev => {
        let delta = Math.floor((ev.time - lastTime) * 128); // 簡易タイミング
        track.addNoteOn(0, ev.note, delta);
        track.addNoteOff(0, ev.note, delta + 64);
        lastTime = ev.time;
      });

      let blob = new Blob([file.toBytes()], { type: "audio/midi" });
      let url = URL.createObjectURL(blob);
      let a = document.createElement("a");
      a.href = url;
      a.download = "voice.mid";
      a.click();
    };
  </script>
</body>
</html>
