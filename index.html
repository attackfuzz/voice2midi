<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>録音テスト with ログ</title>
</head>
<body>
  <h2>録音テスト（ログ付き）</h2>
  <button id="startBtn">録音開始</button>
  <button id="stopBtn" disabled>録音停止</button>
  <button id="downloadBtn" disabled>ダウンロード</button>
  <audio id="audioPlayback" controls></audio>

  <pre id="logArea" style="background:#eee; padding:10px; height:200px; overflow:auto;"></pre>

  <script>
    let mediaRecorder;
    let audioChunks = [];
    let audioBlob;

    const startBtn = document.getElementById("startBtn");
    const stopBtn = document.getElementById("stopBtn");
    const downloadBtn = document.getElementById("downloadBtn");
    const audioPlayback = document.getElementById("audioPlayback");
    const logArea = document.getElementById("logArea");

    function log(message) {
      const time = new Date().toLocaleTimeString();
      logArea.textContent += `[${time}] ${message}\n`;
      logArea.scrollTop = logArea.scrollHeight;
    }

    startBtn.addEventListener("click", async () => {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(stream);

        mediaRecorder.onstart = () => {
          log("?? 録音開始");
          audioChunks = [];
          startBtn.disabled = true;
          stopBtn.disabled = false;
          downloadBtn.disabled = true;
        };

        mediaRecorder.ondataavailable = (event) => {
          if (event.data.size > 0) {
            audioChunks.push(event.data);
          }
        };

        mediaRecorder.onstop = () => {
          log("?? 録音停止");
          audioBlob = new Blob(audioChunks, { type: "audio/webm" });
          audioPlayback.src = URL.createObjectURL(audioBlob);
          stopBtn.disabled = true;
          startBtn.disabled = false;
          downloadBtn.disabled = false;
        };

        mediaRecorder.start();
      } catch (err) {
        log("?? マイクの利用が許可されませんでした: " + err);
      }
    });

    stopBtn.addEventListener("click", () => {
      if (mediaRecorder && mediaRecorder.state === "recording") {
        mediaRecorder.stop();
      }
    });

    downloadBtn.addEventListener("click", () => {
      if (audioBlob) {
        log("?? ダウンロード開始");
        const url = URL.createObjectURL(audioBlob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "recorded_audio.webm";
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        log("? ダウンロード完了");
      } else {
        log("?? ダウンロードできるデータがありません");
      }
    });
  </script>
</body>
</html>
