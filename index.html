<!DOCTYPE html>

<html>
<head>
  <meta charset="UTF-8">
  <title>ピッチ検出テスト</title>
</head>
<body>
  <h2>マイク ピッチ検出デモ</h2>
  <button id="startBtn">録音開始</button>
  <button id="stopBtn">停止</button>
  <p>現在の周波数: <span id="freq">--</span> Hz</p>
  <p>音階: <span id="note">--</span></p>

  <script>
    let audioCtx, analyser, source, dataArray, rafId;

    const freqSpan = document.getElementById("freq");
    const noteSpan = document.getElementById("note");

    document.getElementById("startBtn").onclick = async () => {
      audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      source = audioCtx.createMediaStreamSource(stream);
      analyser = audioCtx.createAnalyser();
      analyser.fftSize = 2048;
      dataArray = new Float32Array(analyser.fftSize);
      source.connect(analyser);

      updatePitch();
    };

    document.getElementById("stopBtn").onclick = () => {
      cancelAnimationFrame(rafId);
      if (audioCtx) audioCtx.close();
    };

    function autoCorrelate(buf, sampleRate) {
      let SIZE = buf.length;
      let rms = 0;

      for (let i = 0; i < SIZE; i++) {
        let val = buf[i];
        rms += val * val;
      }
      rms = Math.sqrt(rms / SIZE);
      if (rms < 0.01) return -1;

      let r1 = 0, r2 = SIZE - 1, thres = 0.2;
      for (let i = 0; i < SIZE / 2; i++) {
        if (Math.abs(buf[i]) < thres) { r1 = i; break; }
      }
      for (let i = 1; i < SIZE / 2; i++) {
        if (Math.abs(buf[SIZE - i]) < thres) { r2 = SIZE - i; break; }
      }

      buf = buf.slice(r1, r2);
      SIZE = buf.length;

      let c = new Array(SIZE).fill(0);
      for (let i = 0; i < SIZE; i++)
        for (let j = 0; j < SIZE - i; j++)
          c[i] = c[i] + buf[j] * buf[j + i];

      let d = 0; while (c[d] > c[d + 1]) d++;
      let maxval = -1, maxpos = -1;
      for (let i = d; i < SIZE; i++) {
        if (c[i] > maxval) { maxval = c[i]; maxpos = i; }
      }
      let T0 = maxpos;
      return sampleRate / T0;
    }

    function freqToNote(freq) {
      if (freq <= 0) return "--";
      let noteNum = 12 * (Math.log(freq / 440) / Math.log(2));
      let noteIndex = Math.round(noteNum) + 69;
      const notes = ["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];
      return notes[noteIndex % 12] + Math.floor(noteIndex / 12 - 1);
    }

    function updatePitch() {
      analyser.getFloatTimeDomainData(dataArray);
      let pitch = autoCorrelate(dataArray, audioCtx.sampleRate);
      if (pitch !== -1) {
        freqSpan.textContent = pitch.toFixed(2);
        noteSpan.textContent = freqToNote(pitch);
      } else {
        freqSpan.textContent = "--";
        noteSpan.textContent = "--";
      }
      rafId = requestAnimationFrame(updatePitch);
    }
  </script>
</body>
</html>
