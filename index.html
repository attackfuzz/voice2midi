<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>テンポ付きクオンタイズMIDI風録音</title>
</head>
<body>
  <h2>テンポ付きクオンタイズ MIDI風録音</h2>
  <label>BPM: <input id="bpmInput" type="number" value="120"></label>
  <button id="startBtn">録音開始</button>
  <button id="stopBtn">録音停止</button>
  <button id="playBtn">記録音階 再生</button>
  <pre id="log"></pre>

  <script>
    let audioCtx, analyser, source, mediaStream;
    let recording = false;
    let notes = []; // クオンタイズ後のノート配列
    let rafId;
    let startTime;

    const logArea = document.getElementById("log");
    function log(msg) {
      const t = new Date().toLocaleTimeString();
      logArea.textContent += `[${t}] ${msg}\n`;
      logArea.scrollTop = logArea.scrollHeight;
    }

    function freqToMidi(freq) {
      return Math.round(69 + 12 * Math.log2(freq / 440));
    }

    function midiToNoteName(midi) {
      const names = ["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];
      return names[midi % 12] + Math.floor(midi/12 - 1);
    }

    function autoCorrelate(buf, sampleRate) {
      let SIZE = buf.length;
      let rms = 0;
      for (let i=0;i<SIZE;i++) {
        let val = buf[i];
        rms += val*val;
      }
      rms = Math.sqrt(rms/SIZE);
      if (rms<0.01) return null;

      let bestOffset=-1, bestCorrelation=0;
      for (let offset=80; offset<1000; offset++) {
        let correlation=0;
        for (let i=0;i<SIZE-offset;i++) {
          correlation += buf[i]*buf[i+offset];
        }
        correlation /= SIZE-offset;
        if (correlation>bestCorrelation) {
          bestCorrelation = correlation;
          bestOffset = offset;
        }
      }
      if (bestOffset===-1) return null;
      return sampleRate/bestOffset;
    }

    async function startRecording() {
      if (recording) return;
      const bpm = parseInt(document.getElementById("bpmInput").value, 10);
      const beatLength = 60 / bpm; // 四分音符秒
      const eighthLength = beatLength / 2; // 8分音符秒

      audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      mediaStream = await navigator.mediaDevices.getUserMedia({ audio:true });
      source = audioCtx.createMediaStreamSource(mediaStream);
      analyser = audioCtx.createAnalyser();
      analyser.fftSize = 2048;
      source.connect(analyser);

      const buffer = new Float32Array(analyser.fftSize);
      startTime = audioCtx.currentTime;
      notes = [];

      function update() {
        if (!recording) return;
        analyser.getFloatTimeDomainData(buffer);
        let pitch = autoCorrelate(buffer, audioCtx.sampleRate);
        if (pitch) {
          let midi = freqToMidi(pitch);
          let name = midiToNoteName(midi);

          // 現在の経過時間を8分音符単位にクオンタイズ
          let elapsed = audioCtx.currentTime - startTime;
          let step = Math.round(elapsed / eighthLength);
          notes[step] = {midi, name};

          log(`音検出: ${name} (step=${step})`);
        }
        rafId = requestAnimationFrame(update);
      }
      recording = true;
      update();
      log(`録音開始 (BPM=${bpm})`);
    }

    function stopRecording() {
      if (!recording) return;
      recording = false;
      mediaStream.getTracks().forEach(t=>t.stop());
      cancelAnimationFrame(rafId);
      log("録音停止");
      log("保存されたノート: " + JSON.stringify(notes.filter(Boolean).map(n=>n.name)));
    }

    function playNotes() {
      if (!notes.length) {
        log("再生するノートがありません");
        return;
      }
      const bpm = parseInt(document.getElementById("bpmInput").value, 10);
      const beatLength = 60 / bpm;
      const eighthLength = beatLength / 2;

      const oscCtx = new (window.AudioContext || window.webkitAudioContext)();
      notes.forEach((n, i) => {
        if (!n) return;
        const osc = oscCtx.createOscillator();
        const gain = oscCtx.createGain();
        osc.frequency.value = 440 * Math.pow(2, (n.midi-69)/12);
        osc.type = "sine";
        osc.connect(gain);
        gain.connect(oscCtx.destination);

        const startT = oscCtx.currentTime + i*eighthLength;
        osc.start(startT);
        osc.stop(startT + eighthLength);
      });
      log("記録音階を再生しました");
    }

    document.getElementById("startBtn").onclick = startRecording;
    document.getElementById("stopBtn").onclick = stopRecording;
    document.getElementById("playBtn").onclick = playNotes;
  </script>
</body>
</html>
