<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>MIDIダウンロードテスト</title>
</head>
<body>
  <h1>マイク録音 → MIDI保存（テスト版）</h1>
  <button id="startBtn">録音開始</button>
  <button id="stopBtn">録音停止</button>
  <button id="downloadBtn">MIDIダウンロード</button>
  <p id="status"></p>

  <script>
    let mediaRecorder;
    let audioChunks = [];

    // 録音開始
    document.getElementById("startBtn").onclick = async () => {
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      mediaRecorder = new MediaRecorder(stream);
      audioChunks = [];

      mediaRecorder.ondataavailable = e => {
        if (e.data.size > 0) audioChunks.push(e.data);
      };

      mediaRecorder.start();
      document.getElementById("status").textContent = "??録音中...";
    };

    // 録音停止
    document.getElementById("stopBtn").onclick = () => {
      if (mediaRecorder && mediaRecorder.state !== "inactive") {
        mediaRecorder.stop();
        document.getElementById("status").textContent = "??停止しました";
      }
    };

    // ダウンロード
    document.getElementById("downloadBtn").onclick = () => {
      // --- 本来は解析してMIDIを生成する処理が入る ---
      // 今はダミーのMIDIバイナリを作成（C4音を1秒）
      const midiData = new Uint8Array([
        0x4D,0x54,0x68,0x64, // "MThd"
        0x00,0x00,0x00,0x06, // header size
        0x00,0x00, // format 0
        0x00,0x01, // tracks
        0x00,0x60, // division

        0x4D,0x54,0x72,0x6B, // "MTrk"
        0x00,0x00,0x00,0x19, // length = 25
        0x00,0x90,0x3C,0x64, // note on C4
        0x81,0x40,0x80,0x3C,0x40, // after 192 ticks note off
        0x00,0xFF,0x2F,0x00 // end of track
      ]);

      const blob = new Blob([midiData], { type: "audio/midi" });
      const url = URL.createObjectURL(blob);

      const a = document.createElement("a");
      a.href = url;
      a.download = "test.mid";
      a.click();
      URL.revokeObjectURL(url);

      document.getElementById("status").textContent = "?? test.mid を保存しました";
    };
  </script>
</body>
</html>
