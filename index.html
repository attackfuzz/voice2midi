<script src="https://cdn.jsdelivr.net/npm/jsmidgen@0.2.6/build/jsmidgen.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/pitchy/dist/pitchy.min.js"></script>

<button id="start">録音開始</button>
<button id="stop">録音停止</button>
<button id="saveMIDI">MIDI保存</button>

<script>
let audioCtx, mic, analyser, dataArray, recording = false, midiEvents = [];

document.getElementById("start").onclick = async () => {
  audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
  mic = audioCtx.createMediaStreamSource(stream);
  analyser = audioCtx.createAnalyser();
  analyser.fftSize = 2048;
  mic.connect(analyser);

  dataArray = new Float32Array(analyser.fftSize);
  recording = true;
  midiEvents = [];
  detectPitch();
};

document.getElementById("stop").onclick = () => {
  recording = false;
};

function detectPitch() {
  if (!recording) return;
  analyser.getFloatTimeDomainData(dataArray);
  const [pitch, clarity] = Pitchy.findPitch(dataArray, audioCtx.sampleRate);

  if (clarity > 0.8) { // 信頼度が高ければ
    const midiNote = Math.round(69 + 12 * Math.log2(pitch / 440));
    midiEvents.push({ time: audioCtx.currentTime, note: midiNote });
    console.log("Detected note:", midiNote);
  }
  requestAnimationFrame(detectPitch);
}

document.getElementById("saveMIDI").onclick = () => {
  const file = new JSMidi.File();
  const track = new JSMidi.Track();
  file.addTrack(track);

  midiEvents.forEach((e, i) => {
    track.addNoteOn(0, e.note, i * 128);  // 簡易的に配置
    track.addNoteOff(0, e.note, i * 128 + 64);
  });

  const blob = new Blob([file.toBytes()], { type: "audio/midi" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "recorded.mid";
  a.click();
};
</script>
